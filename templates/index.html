<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>NYC Council Legislation Search</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

<style>
.navbar {
  background: #2f56a6;
  color: #fff;
  padding-top: 1rem;
  padding-bottom: 1rem;
  margin-bottom: 1rem;
}
.navbar-brand {
  /*color: inherit;*/
}
.navbar a {
  color: inherit;
}
.h1 {
  font-size: 2rem;
}


.btn-primary {
  background: #2f56a6;
  border-color: #2f56a6;
}
#search {
  margin: 2rem 0;
}



.legislation {
  margin-bottom: 1.25rem;
}
.legislation .title {
  font-size: .8rem;
  color: #333;
  margin-left: 3rem;
  display: block;
}

.file::before {
  content: url('data:image/svg+xml; utf8, <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>');
  display: inline-block;
  margin: 0px 2px 0 0px;
}

.file {
  line-height: 1rem;
  font-size: .85rem;
  text-decoration: inherit;
}



footer {
  text-align: center;
  font-size: .75rem;
  color: #999;
  padding: 2rem 1rem;
}
footer a:link, footer a:visited {
  color: #777;
}
footer p {
  margin-bottom: .5rem;
}
    </style>

    <title>Intro.NYC</title>
  </head>
  <body>

<nav class="navbar">
  <div class="container-fluid">
    <a class="navbar-brand" href="https://intro.nyc/">Intro.NYC</a>
    <span class="h1">New York City Council Legislation</span>
    <a href="https://legistar.council.nyc.gov/Legislation.aspx"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-external-link"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg> legistar.council.nyc.gov</a> 
  </div>
</nav>

<div class="container">

  <div class="row">

<div id="search-loading">
<div class="spinner-border text-primary" role="status" ></div>
Search Loading...
</div>

<div id="search" style="display:none;">
<form action="/" method="GET">

<div class="input-group mb-1">
  <input type="text" class="form-control" placeholder='ex: "transportation"' id="q" name="q">
  <button class="btn btn-primary" type="submit" id="search-btn">üîç Search</button>
</div>

</form>

</div>

</div>
<div class="row">

<template id="legislation-template">
  <div class="legislation">
    <a href="" class="file-link"><span class="badge bg-secondary file"></span></a> <span class="name"></span>
    <span class="badge bg-success status">Enacted</span>
    <br>
    <span class="title"></span>
  </div>
</template>

<div id="results"></div>

</div>

<div class="row">

<footer>
<p>Made with ‚ù§Ô∏è by <a href="https://jehiah.cz/">@jehiah</a>. Code on <a href="https://github.com/jehiah/intro.nyc/">GitHub</a>.</p>
<p>Data from <a href="https://council.nyc.gov/legislation/api/">NYC Council Legislative API</a></p>
</footer>

</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FlexSearch/0.7.2/flexsearch.es5.js" integrity="sha512-wz43ZAB8+0NQD7Yd+QC9afZaVxkC74GLPn0IzewyfExb88Cziu7fD6iUZYyjAMCT3n5mR/80rB73tOJin4UKsw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script type="text/javascript">
// TODO
// is 'template' supported
// if ('content' in document.createElement('template')) {


// bootstrap search from URL
const urlSearchParams = new URLSearchParams(window.location.search)
document.getElementById("q").value = urlSearchParams.get("q");


// tokenizer: forward
// encoder: advanced
const index = new FlexSearch.Document({
    charset: "latin:advanced", 
    tokenize: "forward",
    // filter: [
    // // words to filter out
    // "in"
    // "legislation"
    // ]
    // resolution: 15,
    document : {
      id: "File",
      index: ["File", "Name", "Title", "Summary"],
    }
});

var lookupData = {};

Promise.all([
  fetch('/data/2021.json'),
  fetch('/data/2020.json'),
  fetch('/data/2019.json'),
  fetch('/data/2018.json'),
]).then(responses => {
  // Get a JSON object from each of the responses [odd quirk]
  return Promise.all(responses.map(function (response) {
    return response.json();
  }));
}).then(data => {
  // console.log("data", data)
  data.forEach(d => {    
    // index.add(d)
    d.forEach(dd => {
      dd.IntroDt = new Date(dd.IntroDate)
      index.add(dd)
      lookupData[dd.File] = dd
    })
  })
}).then(_ =>{
  document.getElementById("search-loading").style.display = 'none';

  const q = document.getElementById("q");
  document.getElementById('search').style.display = '';
  search(q.value)
  q.addEventListener("input", onsearchupdate);
})

function onsearchupdate() {
  const q = document.getElementById("q");
  history.pushState(null, document.title, "/?q=" + encodeURIComponent(q.value))
  search(q.value)
}

function search(q) {
  document.querySelector("#results").innerHTML = '';
  var results = index.search(q, 50)
  // console.log("results", results)
  var seen = {};
  var resultArray = [];
  var hasResults = false;
  results.forEach(r => {
    r.result.forEach(file => {
      if (seen[file]) {return}
      seen[file] = true;
      hasResults = true;
      resultArray.push(lookupData[file])
    })
  })
  if (!hasResults) {
    // add "no results"
    p = document.createElement("p")
    p.textContent = "No results"
    document.querySelector("#results").appendChild(p)
  } else {
    resultArray.sort((a, b) => {return b.IntroDt - a.IntroDt})
    resultArray.forEach(d => addResult(d))
  }
}
function addResult(row) {
    // console.log("addResult", row)
    var target = document.querySelector("#results");
    var template = document.querySelector('#legislation-template');
    var clone = template.content.cloneNode(true);
    const file = row.File.replace("Int ", "")
    clone.querySelectorAll(".file-link")[0].href="/" + file;
    clone.querySelectorAll(".file")[0].textContent="intro.nyc/"+file;
    clone.querySelectorAll(".name")[0].textContent=row.Name;
    clone.querySelectorAll(".title")[0].textContent=row.Title;
    var enacted = false;
    if (row.StatusName == "Enacted (Mayor's Desk for Signature)" || row.StatusName == "Enacted") {
      enacted = true;
    }
    clone.querySelectorAll(".status")[0].style.display = enacted ? "" : "none";
    target.appendChild(clone);

}

</script>


  </body>
</html>